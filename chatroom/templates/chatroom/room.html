 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
 <script>
    function sendMessage() {
        var user="{{ username }}"
        // Get the message text from the input field
        var messageText = document.getElementById("message-input").value;
        
        // Clear the message input
        document.getElementById("message-input").value = "";
        
        // Update the chat window with the new message
        var chatWindow = document.getElementById("chat-window");
        chatWindow.innerHTML += "<p>" + user + " : " + messageText + "</p>";

}
</script>

<h1>Chatroom : {{ nameOfTheRoom }}</h1>
<p>User : {{ username }}
</p>
<!--<form action="send.js" onsubmit="sendMessage()">
    {% csrf_token %}
    <input type="text" placeholder="Enter your message" id="message-input" name="message">
    <input type="submit" value="Send">
</form> -->
<form method="POST" action="" id="messageForm">
    {% csrf_token %}
    <input type="text" placeholder="Type a message" name="messageSent" id="messageSent">
    <input type="hidden" name="chatRoomName" id="chatRoomName" value="{{chatRoomName}}"> <!--on récupère le salon où a été envoyé le message-->
    <input type="hidden" name="whoSent" id="whoSent" value="{{username}}"> <!--on récupère l'utolosateur qui a envoyé le message-->
    <button type="submit">Send</button> <!--On récupère tous les infos du message avec le submit-->
</form>
<script>
    $('#messageForm').submit(function(event) {
        event.preventDefault(); // on empêche le formulaire de s'envoyer normalement ce qui ferait rafraichir la page, à la place on execute le code suivant
        $.ajax({ //requete ajax au serveur, 
            url: '/send/', //à cette url, appelle la vue sendMessage et la stocke avec les données suivantes
            type: 'POST', //POST, on envoie des données au serveur
            data: {
                messageSent: $('#messageSent').val(),
                chatRoomName: $('#chatRoomName').val(), //val() pour récupérer les valeurs
                whoSent: $('#whoSent').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                document.getElementById("messageSent").value="" //on vide le formulaire
                }
            }
        });
    });
</script>
<script>
setInterval(function(){
    var url='/get/{{nameOfTheRoom}}'
    $.ajax({
        url: url,
        type: 'GET', //GET, on reçoit des donénes du serveur
        dataType: 'json',
        success: function(response) {
            $('#chatWindow').empty(); 
            var username="{{who}}"
            for (let i = 0; i < response.allMessagesList.length; i++) {
                $('#chatWindow').append(
                    '<p>' + response.allMessagesList[i].who + " : " + response.allMessagesList[i].allMessagesValue + '</p>' //on récupère la valeur ième allMessagesValue de la liste allMessagesList
                );
            }
        }
    });
},200) //rafraichis la requête toutes les 200ms
</script>
<div id="chatWindow">

</div>
<!-- 
<input type="text" id="message-input">
<button onclick="sendMessage()">Send</button>
<div id="chat-window" style="height: 300px; overflow-y: scroll;">
 //This is where the chat messages will be displayed
    <p>Welcome to the chatroom !</p>
  </div> -->
<p><a href={% url 'home' %}>Go</a> to the homepage</p>