{% load static %}
<!doctype html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    function messageSubmit(event) { //fonction qui est appelée quand on appuie sur le bouton submit
        event.preventDefault(); // empêche le formulaire de se soumettre normalement ce qui ferait rafrachir la page
        $.ajax({ //requete ajax au serveur, 
            url: '/send/', //à cette url, appelle la vue sendMessage et la stocke avec les données suivantes
            type: 'POST', //POST, on envoie des données au serveur
            data: {
                messageSent: $('#messageSent').val(),
                chatRoomName: $('#chatRoomName').val(), //val() pour récupérer les valeurs
                whoSent: $('#whoSent').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isEmpty) {
                    alert("You can't send an empty message !")
                }
                else if (response.isMuted) { // si l'utilisateur est muet, on affiche un message d'erreur
                    alert("You are muted !")
                }
                else if (response.canEnter) {
                    alert("You shouldn't be in this room ! Get out !")
                    window.location.href='/' // on redirige vers la page d'accueil si l'utilisateur est banni et qu'il tente d'envoyer un message
                }
                else {
                document.getElementById("messageSent").value="" //on vide le formulaire
                }
            },
            error: function(response) { //si le salon n'existe pas, une erreur est renvoyée, et on redirige vers la page d'accueil
                alert("This room doesn't exist ! Please go to the home page !")
                window.location.href='/' // on redirige vers la page d'accueil si l'utilisateur tente d'envoyer un message dans un salon qui n'existe pas
            }
        });
    }
    function deleteMessage(messageId) { // on récupère l'id du message qu'on cherche à supprimer
        $.ajax({
            url : '/deleteMessage/', // redirige vers cette url pour que la vue deleteMessage soit appelée 
            type : 'POST',
            data : {
                messageId: messageId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
        })
    }
    function muteUser(username) {
        $.ajax({
            url: '/muteUser/',
            type: 'POST',
            data: {
                username: username,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isMuted) {
                    alert("User " + username + " is muted already")
                }
            }
        })
    };
    function unmuteUser(username) {
        $.ajax({
            url: '/unmuteUser/',
            type: 'POST',
            data: {
                username: username,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isNotMuted) {
                    alert("User " + username + " is unmuted already")
                }
            }
        })
    };
    function banUser(username) {
        $.ajax({
            url: '/banUser/',
            type: 'POST',
            data: {
                username: username,
                roomName: "{{nameOfTheRoom}}",
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isBanned) {
                    alert("User " + username + " is banned already")
                }
            }
        })
    };
    function unbanUser(username) {
        $.ajax({
            url: '/unbanUser/',
            type: 'POST',
            data: {
                username: username,
                roomName: "{{nameOfTheRoom}}",
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isNotBanned) {
                    alert("User " + username + " is unbanned already")
                }
            }
        })
    };
    function changeMessage(messageId) {
        var newMessage= prompt("Enter the new message")
        $.ajax({
            url: '/changeMessage/',
            type: 'POST',
            data: {
                messageId: messageId,
                newMessage: newMessage,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function(response) {
                if (response.isEmpty) {
                    alert("You can't send an empty message !")
                }
            }
        })
    }
    setInterval(function(){
        var url='/get/{{nameOfTheRoom}}'
        $.ajax({
            url: url,
            type: 'GET', //GET, on reçoit des donénes du serveur
            dataType: 'json',
            success: function(response) {
                document.getElementById("chatWindow").innerHTML = "" //on vide la fenêtre de chat à chaque rafraichissement de la page pour éviter les doublons de messages
                //sinon les messages s'affichent plusieurs fois
                var username="{{who}}"
                for (let i = 0; i < response.allMessagesList.length; i++) {
                    document.getElementById("chatWindow").innerHTML+='<p>' + response.allMessagesList[i].when + " " + response.allMessagesList[i].who + " : " + 
                    response.allMessagesList[i].allMessagesValue +'</p>' // //on récupère la valeur ième allMessagesValue de la liste allMessagesList
                    if (response.allMessagesList[i].who == "{{ username }}") { //permet à l'utilisateur de supprimer ses propres messages
                        var deletetionButton=document.createElement("button")
                        deletetionButton.innerHTML="Delete"
                        deletetionButton.setAttribute("onclick", "deleteMessage("+response.allMessagesList[i].messageId+")")
                        document.getElementById("chatWindow").appendChild(deletetionButton)

                        var changeButton=document.createElement("button")
                        changeButton.innerHTML="Change"
                        changeButton.setAttribute("onclick", "changeMessage("+response.allMessagesList[i].messageId+")")
                        document.getElementById("chatWindow").appendChild(changeButton)
                    }
                    else {
                        {% if user.is_superuser %} // s'il s'agit d'un super utilisateur, crée des boutons de suppression pour chaque message
                            var deletetionButton=document.createElement("button")
                            deletetionButton.innerHTML="Delete"
                            deletetionButton.setAttribute("onclick", "deleteMessage("+response.allMessagesList[i].messageId+")")
                            document.getElementById("chatWindow").appendChild(deletetionButton)
                        {% endif %}
                    }
                }
            }
        });
        {% if user.is_superuser %}
        $.ajax({
            url: '/getUsers/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                document.getElementById("userWindow").innerHTML = ""
                for (let i = 0; i < response.users.length; i++) {
                    document.getElementById("userWindow").innerHTML += '<p>' + response.users[i].username + '</p>'

                    var muteUser=document.createElement("button")
                    muteUser.innerHTML="Mute user"
                    muteUser.setAttribute("onclick", "muteUser('"+response.users[i].username+"')")
                    document.getElementById("userWindow").appendChild(muteUser)

                    var unmuteUser=document.createElement("button")
                    unmuteUser.innerHTML="Unmute user"
                    unmuteUser.setAttribute("onclick", "unmuteUser('"+response.users[i].username+"')")
                    document.getElementById("userWindow").appendChild(unmuteUser)

                    var banUser=document.createElement("button")
                    banUser.innerHTML="Ban User"
                    banUser.setAttribute("onclick", "banUser('"+response.users[i].username+"')")
                    document.getElementById("userWindow").appendChild(banUser)

                    var unbanUser=document.createElement("button")
                    unbanUser.innerHTML="Unban User"
                    unbanUser.setAttribute("onclick", "unbanUser('"+response.users[i].username+"')")
                    document.getElementById("userWindow").appendChild(unbanUser)
                }
            }
        })
        {% endif %}
},300) //envoie une requête toutes les 600ms
</script>
<html lang="fr">
    <head>
        <meta charset="utf-8" />
        <!--<link rel="stylesheet" href="{% static 'style1.css' %}">-->
    </head>
    <body>
        <header>
           <h1>Chatroom : {{ nameOfTheRoom }}</h1>
        </header>
        <section>
            <div>
                <h2>User : {{ username }} </h2>
            </div>
            <div class="form-container">
                <h3>
                <a href="{% url 'home' %}"> Go to the homepage</a>   
                </h3>
            </div>
        </section>
        <div id="chatWindow"></div>
        <form method="POST" action="" id="messageForm" onsubmit="return messageSubmit(event)">
            {% csrf_token %}
            <input type="text" placeholder="Type a message" name="messageSent" id="messageSent">
            <input type="hidden" name="chatRoomName" id="chatRoomName" value="{{chatRoomName}}"> <!--on récupère le salon où a été envoyé le message-->
            <input type="hidden" name="whoSent" id="whoSent" value="{{username}}"> <!--on récupère l'utolosateur qui a envoyé le message-->
            <button type="submit">Send</button> <!--On récupère tous les infos du message avec le submit-->
        </form>
        {% if user.is_superuser %}
            <h2>User list</h2>
        <div id="userWindow"></div>
            {% endif %}
     </body>
</html>    
